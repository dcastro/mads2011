<%# encoding: UTF-8 %>

<p id="notice"><%= notice %></p>


 <script type="text/javascript" >
	
	var filled = false;
	var projectid = <%= @project.id %>;

	$(function() {

		$( "#username" ).autocomplete({
			 source:  function(request, response) {
			 
			 			var tmp = "string="+request.term+ "&projectid="+ projectid;
			 
					    $.ajax({
					      url: "/users/dynamic_search",
					      data: tmp,
					      dataType: "json",
					      type: "GET",
					      success: response
					    });
					    
					  },
                minLength: 1,
			focus: function( event, ui ) {
				$( "#username" ).val( ui.item.name );
				return false;
			},
			select: function( event, ui ) {
				$( "#username" ).val( ui.item.name);
				$("#userid").val(ui.item.id);
				filled = true;
				return false;
			}
		})
		.data( "autocomplete" )._renderItem = function( ul, item ) {
			
			//alert(item.photo);
			return $( "<li></li>" )
				.data( "item.autocomplete", item )
				.append( 
				
				"<a>"  +
				"<img src=\"" + item.get_photo +"\" width=\"30\" height=\"30\">"
				+item.name +
				"</a>")
				.appendTo( ul );
				
		};		
		
	});
	
	
	function submitCheck(){
		
		if(filled == true)
		 	return true;
		 else{
		 	alert("You must specify a name to add to the project");
		 	return false;
		 }
	}

</script>

<p>
  <b>Name:</b>
  <%= @project.name %>
</p>

<p>
  <b>Repo:</b>
  <%= @project.repo %>
</p>



<%= link_to 'Edit', edit_project_path(@project) %> |
<%= link_to 'Back', projects_path %>
<%= button_to "Update State", projects_update_state_path(:id => @project.id) %>

<h2>Users</h2>

<% if @user_type == "Manager"%>

	<%= form_tag(roles_create_path, :method => "post", :onsubmit=>"return submitCheck()") do %>
		
		<%= hidden_field_tag "projectid", @project.id %>
		<%= hidden_field_tag "userid" %>
	
		<%= search_field_tag "username", "username" , :onfocus=>"if(this.value==this.defaultValue) this.value='';"%>
	  	
	  	<%= select_tag "usertype", "<option>Client</option><option>Developer</option><option>Manager</option>".html_safe  %>
	  	<%= submit_tag("Add") %>
	  
	<% end %>

<% end %>

<table class="table">
	
	<tr>
		<th>Name</th>
		<th>Role</th>
		<% if @user_type == "Manager"%>
			<th></th>
		<% end %>
		
	</tr>
	<% i = 0 %>
	<% @project.roles.each do |role|%>
		
		<tr <%= "class='even'" if i%2 == 0 %>>
			<td>
				<%= role.user.name %>
			</td>
			
			<td>
				<%= role.name %>
			</td>
			
			
			<% if @user_type == "Manager"%>
				<td>
					<% if role.user_id !=  session[:id] %>
					 
						<%= form_tag(roles_remove_path, :method => "post") do %>
							<%= hidden_field_tag "userid", role.user.id %>
							<%= hidden_field_tag "projectid", @project.id %>
						  	<%= submit_tag("Delete", id: "remove_" + role.user.username) %>
						<% end %>
						
					<% end %>
				</td>
			<% end %>
			
			</tr>
			<% i+=1%>
	<% end %>
	
</table>


<h2>Features</h2>

<% unless @project.features.empty? %>

	<table class="table">
		<tr>
			<th>Name</th>
			<th>State</th>
		</tr>
		<% @project.features.each do |feature| %>
			<tr>
				<td><%= link_to feature.name, features_show_path(:id => feature.id) %></td>
				<td><%= (feature.done)? "✔" : "✘" %></td>
			</tr>
		<% end %>	
	</table>

<% else %>
	There are no features in this project. Have you tried updating the project's state?
<% end %>

